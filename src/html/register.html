<!DOCTYPE html>
<html lang="en">

   <head>
      <meta charset="UTF-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Registration Form</title>
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
         integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
   </head>

   <body>
      <div id="menu"></div>
      <div class="container p-3">
         <div class="input-group mb-3">
            <input id="email" type="email" required="required" class="form-control" placeholder="Email" aria-label="Email"
               aria-describedby="basic-addon1">
         </div>
         <label style="font-size: 80%; color: grey;">The nickname must be at least 4 char long and maximum 16.</label>
         <div class="input-group mb-3">
            <input id="nickname" type="text" required="required" class="form-control" placeholder="Nickname" aria-label="Nickname"
               aria-describedby="basic-addon1">
         </div>
         <p style="font-size: 80%; color: grey;">The password must be at least 7 char long.</p>
         <div class="input-group mb-3">
            <input id="password1" type="password" required="required" class="form-control" placeholder="Password" aria-label="Password"
               aria-describedby="basic-addon1">
            <input id="password2" type="password" required="required" class="form-control" placeholder="Repeat Password"
               aria-label="Password" aria-describedby="basic-addon1">
         </div>
         <div class="input-group mb-3">
            <input id="nome" type="text" class="form-control" placeholder="Nome" aria-label="Nome"
               aria-describedby="basic-addon1">
            <input id="cognome" type="text" class="form-control" placeholder="Cognome" aria-label="Cognome"
               aria-describedby="basic-addon1">
         </div>
         <div class="input-group mb-3">
            <input id="data_di_nascita" type="date" class="form-control" placeholder="Data di nascita"
               aria-label="Data di nascita" min="1900-01-01" aria-describedby="basic-addon1">
         </div>
         <label for="generi" class="form-label">Seleziona i generi musicali:</label>
         <div class="input-group mb-3">
            <select id="generi" class="form-select selectpicker" multiple data-live-search="true">
            </select>
         </div>
         <div class="input-group mb-3">
            <button onclick="registrati()" class="btn btn-primary">Registrati</button>
         </div>
         <p class="mt-3">Hai già un account? <a href="http://localhost:3000/login">Effettua il login</a></p>
      </div>

      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
      crossorigin="anonymous"></script>
      <script type="module" src="scripts/menu.js"></script>

      <script>

/*
       document.getElementById("data_di_nascita").addEventListener("input", function() { -->
      <!--    var input = this.value; -->
      <!--    var dateEntered = new Date(input); -->
      <!--    let day = dateEntered.getDay(); -->
      <!--    let month = dateEntered.getMonth(); -->
      <!--    let year = dateEntered.getYear(); -->
      <!--    if (year < 0 || year > 123) this.value = new Date("0" + month + day) -->
      <!--    // console.log(dateEntered); //e.g. Fri Nov 13 2015 00:00:00 GMT+0000 (GMT Standard Time) -->
      <!-- }); 

      */

      // Funzione per ottenere i generi musicali da Spotify
      async function getSpotifyGenres() {
         try {
            const response = await fetch('http://localhost:3000/getGenres', {
               method: 'GET',
               headers: {
                  'Content-Type': 'application/json'
               }
            });

            if (response.ok) {
               const data = await response.json();
               return data.genres;
            } else {
               throw new Error('Failed to fetch genres');
            }
         } catch (error) {
            console.error('An error occurred:', error);
            throw error;
         }
      }

      </script>
      <script>
      // Function to populate genres dropdown with multiple selection
      async function populateGenresDropdown() {
         const genres = await getSpotifyGenres();
         const generiDropdown = document.getElementById('generi');

         genres.forEach(genre => {
            const option = document.createElement('option');
            option.value = genre;
            option.text = genre;
            generiDropdown.appendChild(option);
         });

         // Enable multiple selection for the dropdown
         generiDropdown.setAttribute('multiple', 'multiple');
      }

      // Call the populateGenresDropdown function when the page is loaded
      document.addEventListener('DOMContentLoaded', populateGenresDropdown);
      </script>


      <script>
      function registrati() {
         var email = document.getElementById('email');
         var nickname = document.getElementById('nickname');
         var password1 = document.getElementById('password1');
         var password2 = document.getElementById('password2');
         var nome = document.getElementById('nome');
         var cognome = document.getElementById('cognome');
         var data_di_nascita = document.getElementById('data_di_nascita');
         var generi = document.getElementById("generi");

         // Controllo password
         if (password1.value != password2.value || password1.value.length < 7) {
            password1.classList.add('border');
            password1.classList.add('border-danger');
            password2.classList.add('border');
            password2.classList.add('border-danger');
            alert("Le password devono coincidere ed essere lunghe almeno 7 caratteri!");
            return;
         } else {
            password1.classList.remove('border');
            password1.classList.remove('border-danger');
            password2.classList.remove('border');
            password2.classList.remove('border-danger');
         }
         // Controllo data di nascita
         var dataPattern = /^\d{4}-\d{2}-\d{2}$/;
         if (!dataPattern.test(data_di_nascita.value)) {
            data_di_nascita.classList.add('border');
            data_di_nascita.classList.add('border-danger');
            alert("Inserisci una data di nascita valida nel formato yyyy-mm-dd!");
            return;
         } else {
            data_di_nascita.classList.remove('border');
            data_di_nascita.classList.remove('border-danger');
         }

         var dataParts = data_di_nascita.value.split('-');
         var year = parseInt(dataParts[0]);
         var month = parseInt(dataParts[1]);
         var day = parseInt(dataParts[2]);

         if (isNaN(year) || isNaN(month) || isNaN(day)) {
            data_di_nascita.classList.add('border');
            data_di_nascita.classList.add('border-danger');
            alert("Inserisci una data di nascita valida nel formato yyyy-mm-dd!");
            return;
         }

         var currentDate = new Date();
         if (year < 1900 || year > currentDate.getFullYear() || month < 1 || month > 12 || day < 1 || day > 31) {
            data_di_nascita.classList.add('border');
            data_di_nascita.classList.add('border-danger');
            alert("Inserisci una data di nascita valida!");
            return;
         } else {
            data_di_nascita.classList.remove('border');
            data_di_nascita.classList.remove('border-danger');
         }
         // Controllo email con regexp
         var emailPattern = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/;
         if (!emailPattern.test(email.value)) {
            email.classList.add('border');
            email.classList.add('border-danger');
            alert("Inserisci un indirizzo email valido!");
            return;
         } else {
            email.classList.remove('border');
            email.classList.remove('border-danger');
         }

         // Controllo nickname con lunghezza e regexp
         var nicknamePattern = /^[a-zA-Z0-9_]{4,16}$/;
         if (!nicknamePattern.test(nickname.value)) {
            nickname.classList.add('border');
            nickname.classList.add('border-danger');
            alert("Il nickname deve avere tra 4 e 16 caratteri e contenere solo lettere, numeri e underscore!");
            return;
         } else {
            nickname.classList.remove('border');
            nickname.classList.remove('border-danger');
         }

         // Controllo altri campi
         if (!nome.value) {
            nome.classList.add('border');
            nome.classList.add('border-danger');
            alert("Inserisci il tuo nome!");
            return;
         } else {
            nome.classList.remove('border');
            nome.classList.remove('border-danger');
         }

         if (!cognome.value) {
            cognome.classList.add('border');
            cognome.classList.add('border-danger');
            alert("Inserisci il tuo cognome!");
            return;
         } else {
            cognome.classList.remove('border');
            cognome.classList.remove('border-danger');
         }

         // Altri controlli
         var generi_selezionati = document.querySelectorAll("#generi :checked");
         var generi_selezionati_values = [];
         for (var i = 0; i < generi_selezionati.length; i++) {
            generi_selezionati_values.push(generi_selezionati[i].value);
         }

         var data = {
            name: nome.value,
            nickname: nickname.value,
            surname: cognome.value,
            email: email.value,
            password: password1.value,
            date: data_di_nascita.value,
            genres: generi_selezionati_values // Includi l'array dei generi selezionati
         };

         // console.log(data);

         fetch("http://localhost:3000/register", {
            method: "POST",
            headers: {
               "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
         }).then(async response => {
               if (response.ok) {
                  alert("Registrazione avvenuta con successo, verrai reindirizzato alla pagina di login");
                  setTimeout(function () {
                     window.location.href = "http://localhost:3000/login";
                  }, 500); // Ritarda l'href di 0,5 secondi (500 millisecondi)
               }
               else {
                  alert("Impossibile effettuare la registrazione: indirizzo email già in uso!");
               }
            });
      }

      </script>
   </body>

</html>
