<!DOCTYPE html>
<html lang="en">

   <head>
      <meta charset="UTF-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Document</title>
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
         integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
   </head>

   <body>
      <div id="menu"></div>

      <div class="container">
         <div class="mb-3">
            <label for="exampleInputEmail1" class="form-label">Nickname or Email</label>
            <input id="nicknameOrEmail" type="email" class="form-control" id="exampleInputEmail1" aria-describedby="emailHelp">
         </div>
         <div class="mb-3">
            <label for="exampleInputPassword1" class="form-label">Password</label>
            <input id="password" type="password" class="form-control" id="exampleInputPassword1">
         </div>
         <button type="submit" class="btn btn-primary" onclick="login()">Submit</button>
         <p class="mt-3">Non hai un account? <a href="http://localhost:3000/register">Registrati qui</a></p>
      </div>


      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
      crossorigin="anonymous"></script>
      <script src="scripts/menu.js"></script>
      <script>
      document.getElementById('password').onkeydown = function(e) {
         if (e.keyCode == 13) login();
      }

      function login() {
         var nicknameOrEmail = document.getElementById('nicknameOrEmail');
         var password = document.getElementById('password');

         // Rimuovi eventuali classi di errore preesistenti
         nicknameOrEmail.classList.remove('border', 'border-danger');
         password.classList.remove('border', 'border-danger');

         // Verifica validità mail || nickname
         const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
         const isValidEmail = emailRegex.test(nicknameOrEmail.value);

         if (!isValidEmail && (
            !nicknameOrEmail.value ||
               nicknameOrEmail.value.length < 4 ||
               nicknameOrEmail.value.length > 16)) {

            nicknameOrEmail.classList.add('border', 'border-danger');
            alert("Inserisci il nickname o un indirizzo email valido!");
            return;
         }

         // Verifica validità password
         if (!password.value || password.value.length < 7) {
            password.classList.add('border', 'border-danger');
            alert("La password deve avere almeno 7 caratteri!");
            return;
         }

         var data = {
            email: isValidEmail ? nicknameOrEmail.value : undefined,
            nickname: !isValidEmail ? nicknameOrEmail.value : undefined,
            password: password.value
         };

         // Effettua la richiesta POST al server
         fetch("/login", {
            method: "POST",
            headers: {
               "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
         }).then(response => {
               if (response.ok) {
                  response.json().then(responseData => {
                     let container = document.getElementsByClassName('container')[0];
                     console.log(container);

                     container.innerHTML += `
                     <div class="alert alert-success" role="alert" aria-hidden="true">
                       <h4 class="alert-heading">Loggato con successo!</h4>
                     </div>`

                     // TODO:  think about save an object in localStorage instead of 3/4 keys

                     // Save user_id in localStorage
                     localStorage.setItem("_id", responseData._id);
                     // Save user credentials in LocalStorage
                     localStorage.setItem("email", responseData.email);
                     localStorage.setItem("nickname", responseData.nickname);
                     // Reindirizza alla pagina di login
                     setTimeout(() => { window.location.href = '/login' }, 2000);
                  });
               } else {
                  alert("Credenziali non valide o inesistenti!");
               }
            });
      }

      </script>
      <script>
      // Check if user is logged in
      var email = localStorage.getItem("email");
      var nickname = localStorage.getItem("nickname");

      if (email && nickname) {
         // User is logged, bring him to profile page
         window.location.href = "/profile";
      }
      </script>

   </body>

</html>
